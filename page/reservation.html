<!DOCTYPE html>
<html lang="en" data-theme="nord">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />

		<link rel="shortcut icon" href="../img/pool-icon.png" type="image/x-icon" />
		<link rel="stylesheet" href="../css/index.css" />
		<link
			href="https://cdn.jsdelivr.net/npm/daisyui@4.12.7/dist/full.min.css"
			rel="stylesheet"
			type="text/css"
		/>
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
		/>
		<link
			rel="stylesheet"
			href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
		/>

		<title>Nilam Public Swimming Pool</title>
	</head>
	<body>
		<!-- Navbar -->
		<div class="sticky top-0 z-50 navbar bg-secondary text-secondary-content">
			<div class="navbar-start">
				<div class="dropdown">
					<div tabindex="0" role="button" class="btn btn-ghost btn-circle">
						<svg
							xmlns="http://www.w3.org/2000/svg"
							class="h-5 w-5"
							fill="none"
							viewBox="0 0 24 24"
							stroke="currentColor"
						>
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M4 6h16M4 12h16M4 18h7"
							/>
						</svg>
					</div>
					<ul
						tabindex="0"
						class="menu menu-sm dropdown-content bg-base-100 rounded-box z-[1] mt-3 w-52 p-2 shadow"
					>
						<li>
							<a href="home.html">Home</a>
						</li>
						<li>
							<a href="gallery.html">Gallery</a>
						</li>
						<li>
							<a href="services-&-facilities.html">Services & Facilities</a>
						</li>
						<li>
							<a href="offers.html">Offers</a>
						</li>
						<li>
							<a href="reservation.html" class="active">Reservation</a>
						</li>
						<li>
							<a href="reviews.html">Reviews</a>
						</li>
						<div id="adminLinkDivider" class="divider divider-start hidden">
							Admin
						</div>
						<li id="adminLink" class="hidden">
							<a href="admin/reservation-list.html">Reservation List</a>
						</li>
					</ul>
				</div>
			</div>
			<div class="navbar-center">
				<a class="text-xl font-bold" href="home.html">Nilam Pool</a>
			</div>
			<div class="navbar-end">
				<div class="dropdown dropdown-end">
					<div tabindex="0" role="button" class="btn btn-ghost btn-circle">
						<div class="w-10 rounded-full">
							<i class="fa-solid fa-user-gear fa-xl"></i>
						</div>
					</div>
					<ul
						tabindex="0"
						class="menu menu-sm dropdown-content bg-base-100 rounded-box z-[1] mt-3 w-52 p-2 shadow"
					>
						<li id="loginLink" class="">
							<label for="loginModal" class="font-medium text-accent-content"
								>Login</label
							>
						</li>
						<li id="logoutLink" class="hidden">
							<button id="logoutBtn" class="font-medium text-accent-content">
								Logout
							</button>
						</li>
						<li>
							<label class="swap swap-rotate flex justify-between">
								<span class="text-accent-content font-medium"
									>Change theme</span
								>
								<label class="swap swap-rotate">
									<!-- this hidden checkbox controls the state -->
									<input type="checkbox" class="theme-controller" value="dim" />

									<!-- sun icon -->
									<i class="swap-off fa-l fa-solid fa-sun"></i>

									<!-- moon icon -->
									<i class="swap-on fa-l fa-solid fa-moon"></i>
								</label>
							</label>
						</li>
					</ul>
				</div>
			</div>
		</div>
		<!-- End Navbar -->

		<!-- Reservation Page -->
		<div class="my-12 flex justify-center">
			<div
				class="card bg-neutral text-neutral-content w-1/2 shrink-0 shadow-2xl"
			>
				<h3 class="text-center font-bold text-2xl mt-8">Reservation</h3>
				<form id="reserveForm" class="card-body">
					<!-- Personal Data -->
					<h3 class="text-lg font-medium">Personal Data</h3>
					<div class="form-control">
						<label class="label">
							<span class="label-text text-neutral-content">Email</span>
						</label>
						<input
							id="email"
							type="email"
							placeholder="email@gmail.com"
							class="input input-bordered text-[black] font-medium"
							required
						/>
					</div>
					<div class="form-control">
						<label class="label">
							<span class="label-text text-neutral-content">Name</span>
						</label>
						<input
							id="name"
							type="text"
							placeholder="Dnsy"
							class="input input-bordered text-[black] font-medium"
							required
						/>
					</div>

					<!-- Ticket -->
					<h3 class="text-lg font-medium mt-2">Ticket</h3>
					<div class="form-control">
						<label class="label">
							<span class="label-text text-neutral-content">Date</span>
						</label>
						<input
							id="datePicker"
							type="date"
							placeholder="Date Reservation"
							class="input text-[black] font-medium input-bordered w-full"
						/>
					</div>
					<div class="flex gap-5">
						<div class="form-control">
							<label class="label">
								<span class="label-text text-neutral-content">Adult</span>
							</label>
							<div class="join join-horizontal">
								<button
									type="button"
									class="btn btn-secondary join-item"
									onclick="decrementTicketAdult()"
								>
									-
								</button>
								<input
									id="ticketAdult"
									type="number"
									value="0"
									class="input rounded-none input-bordered text-[black] font-medium text-center font-bold w-full"
									disabled
								/>
								<input
									id="hiddenTicketAdult"
									type="hidden"
									value="0"
									class="input input-bordered text-[black] font-medium text-center font-bold w-full"
									disabled
								/>
								<button
									type="button"
									class="btn btn-secondary join-item"
									onclick="incrementTicketAdult()"
								>
									+
								</button>
							</div>
						</div>
						<div class="form-control">
							<label class="label">
								<span class="label-text text-neutral-content">Kids</span>
							</label>
							<div class="join join-horizontal">
								<button
									type="button"
									class="btn btn-secondary join-item"
									onclick="decrementTicketKid()"
								>
									-
								</button>
								<input
									id="ticketKid"
									type="number"
									value="0"
									class="input rounded-none input-bordered text-[black] font-medium text-center font-bold w-full"
									disabled
								/>
								<input
									id="hiddenTicketKid"
									type="hidden"
									value="0"
									class="input input-bordered text-[black] font-medium text-center font-bold w-full"
									disabled
								/>
								<button
									type="button"
									class="btn btn-secondary join-item"
									onclick="incrementTicketKid()"
								>
									+
								</button>
							</div>
						</div>
					</div>

					<!-- Additional Offers -->
					<div class="mt-2">
						<h4 class="text-lg font-medium">Additional Offers</h4>

						<div class="form-control">
							<label class="label cursor-pointer">
								<span class="label-text text-neutral-content"
									>Snacks and Lunch</span
								>
								<input
									id="snacksLunch"
									type="checkbox"
									class="checkbox checkbox-secondary"
								/>
							</label>
						</div>
						<div class="form-control">
							<label class="label cursor-pointer">
								<span class="label-text text-neutral-content"
									>Swimming Kit</span
								>
								<input
									id="swimKit"
									type="checkbox"
									class="checkbox checkbox-secondary"
								/>
							</label>
						</div>
					</div>

					<!-- Discount Voucher -->
					<h4 class="text-lg font-medium mt-2">Discount Voucher</h4>
					<div class="form-control">
						<label class="label">
							<span class="label-text text-neutral-content">Voucher</span>
						</label>
						<input
							id="voucher"
							type="text"
							placeholder="D10000"
							class="input input-bordered text-[black] font-medium"
						/>
					</div>

					<!-- Price -->
					<div
						class="card px-5 py-3 bg-accent text-accent-content w-1/4 shadow-2xl fixed bottom-[2rem] right-[1rem]"
					>
						<h3 class="text-xl font-semibold mb-2 text-center">Receipt</h3>
						<h4 class="font-medium text-lg">Ticket</h4>
						<p id="priceDate" class="text-base">Reservation Date: -</p>
						<p id="priceTicketAdult" class="text-base">
							Adult: 0 x Rp30,000 = Rp0,000
						</p>
						<p id="priceTicketKid" class="text-base">
							Kid: 0 x Rp25,000 = Rp0,000
						</p>
						<h4 class="font-medium text-lg">Additional</h4>
						<p id="priceSnacks" class="text-base">Snacks & Lunch: No</p>
						<p id="priceSwimKit" class="text-base">Swimming Kit: No</p>
						<h4 class="font-medium text-lg">Voucher</h4>
						<p id="voucherInfo" class="text-base">Code: Invalid</p>
						<p id="voucherDiscount" class="text-base">Discount: - Rp0,000</p>
						<h4 id="totalPrice" class="font-medium text-lg mt-8">
							Total Price: Rp0,000
						</h4>
					</div>

					<div class="form-control mt-6">
						<button id="reserveBtn" type="submit" class="btn btn-primary">
							Reserve
						</button>
					</div>
				</form>
			</div>
		</div>

		<!-- Confirm Modal -->
		<dialog id="confirmModal" class="modal">
			<div
				class="modal-box flex flex-col items-center bg-secondary text-secondary-content"
			>
				<h3 class="text-lg font-bold">Thanks for Reserved!</h3>
				<p class="py-4">Please save QR Code and scan QR at Gate later!</p>

				<img id="qrcode" alt="QR Code will appear here" class="w-30 h-30" />
				<a
					class="mt-4 btn btn-success rounded-lg mb-5 font-semibold text-lg"
					id="downloadQRBtn"
					download="qrcode.png"
					>Download QR Code</a
				>

				<div class="modal-action">
					<form method="dialog">
						<!-- if there is a button in form, it will close the modal -->
						<button class="btn btn-accent rounded-lg">Close</button>
					</form>
				</div>
			</div>
		</dialog>

		<!-- Scanned Modal -->
		<dialog id="scannedModal" class="modal">
			<div
				class="modal-box flex flex-col items-center bg-secondary text-secondary-content"
			>
				<h3 class="text-lg font-bold mb-5">QR Code Information</h3>

				<pre id="decodedText"></pre>

				<div class="modal-action">
					<form method="dialog">
						<!-- if there is a button in form, it will close the modal -->
						<button class="btn btn-accent rounded-lg">Close</button>
					</form>
				</div>
			</div>
		</dialog>

		<!-- Scan QR Code -->
		<button
			id="scanQRBtn"
			class="btn z-10 bg-accent hover:bg-primary border-none shadow-xl btn-square fixed bottom-[2rem] left-[2rem]"
		>
			<i class="fa-solid fa-qrcode"></i>
		</button>
		<input
			type="file"
			id="fileInput"
			accept="image/*"
			class="file-input hidden file-input-bordered file-input-accent w-full max-w-xs"
		/>

		<!-- Login Modal -->
		<input type="checkbox" id="loginModal" class="modal-toggle" />
		<div class="modal" role="dialog">
			<div class="modal-box">
				<form class="card-body">
					<div class="form-control">
						<label class="label">
							<span class="label-text">Username</span>
						</label>
						<input
							id="username"
							type="text"
							placeholder="username"
							class="input input-bordered"
							required
						/>
					</div>
					<div class="form-control">
						<label class="label">
							<span class="label-text">Password</span>
						</label>
						<input
							id="password"
							type="password"
							placeholder="password"
							class="input input-bordered"
							required
						/>
					</div>
					<div class="form-control mt-6">
						<button id="loginBtn" type="button" class="btn btn-primary">
							Login
						</button>
					</div>
				</form>
			</div>
			<label class="modal-backdrop" for="loginModal">Close</label>
		</div>

		<!-- Toast Status Login -->
		<div id="loginStatus" class="toast"></div>
		<!-- End Reservation Page -->

		<!-- Footer -->
		<footer
			class="footer bg-secondary text-secondary-content p-10 items-center"
		>
			<nav>
				<h6 class="footer-title">Location</h6>
				<iframe
					class="rounded"
					width="500"
					height="300"
					frameborder="0"
					scrolling="no"
					marginheight="0"
					marginwidth="0"
					src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d1982.9259081418036!2d106.87306403840144!3d-6.283202432326569!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x2e69f28e678fbc9f%3A0xbedbf07d7e3182e7!2sKolam%20Renang%20Nilam%20Kramat%20Jati!5e0!3m2!1sen!2sus!4v1719221456059!5m2!1sen!2sus"
					allowfullscreen=""
					loading="lazy"
					referrerpolicy="no-referrer-when-downgrade"
				></iframe>
			</nav>
			<aside class="grid-flow-row justify-items-center items-center gap-5">
				<i class="fa-solid fa-person-swimming fa-3x fa-flip-horizontal"></i>

				<div class="text-center">
					<p class="text-xl font-bold mb-2">Nilam Public Swimming Pool</p>
					<p class="text-base font-bold mt-0">
						Providing swimming pool since 2016
					</p>
				</div>

				<div class="grid grid-flow-col gap-4">
					<a>
						<i class="fa-brands fa-x-twitter fa-xl"></i>
					</a>
					<a>
						<i class="fa-brands fa-youtube fa-xl"></i>
					</a>
					<a>
						<i class="fa-brands fa-facebook-f fa-xl"></i>
					</a>
					<a>
						<i class="fa-brands fa-whatsapp fa-xl"></i>
					</a>
				</div>

				<div>
					<p class="text-sm">
						Copyright © 2024 - All right reserved by Nilam Swimming Pool
					</p>
				</div>
			</aside>
		</footer>
		<!-- End Footer -->

		<script src="../js/index.js"></script>
		<script src="../js/reservation.js"></script>
		<script src="../js/login.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
		<script type="module">
			import { myModule } from "../js/tailwind.config.js";
			myModule();
		</script>
		<script src="https://cdn.tailwindcss.com"></script>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
		<script>
			flatpickr("#datePicker", {
				enableTime: false,
				dateFormat: "F J, Y",
				minDate: "today",
			});
			let currentQRCodeURL = "";
			let price = {
				adult: 0,
				kid: 0,
				snacks: 0,
				swimKit: 0,
				discount: 0,
				totalTicket: 0,
				totalPrice: 0,
			};

			document
				.getElementById("reserveForm")
				.addEventListener("submit", function (e) {
					e.preventDefault();
					const data = {
						email: document.getElementById("email").value,
						name: document.getElementById("name").value,
						date: document.getElementById("datePicker").value,
						ticketAdult: document.getElementById("ticketAdult").value,
						ticketKid: document.getElementById("ticketKid").value,
						snacks: document.getElementById("snacksLunch").checked,
						swimKit: document.getElementById("swimKit").checked,
						voucher: document.getElementById("voucher").value
							? document.getElementById("voucher").value
							: "-",
						discount: checkDiscountForReceipt(),
					};

					saveReservation(data);

					const qrText = `Personal Data\nEmail: ${data.email}\nName: ${
						data.name
					}\n\nTicket\nReservation Date: ${
						data.date
					}\nAdult: ${countTotalPriceForReceipt(
						"adult"
					)}\nKid: ${countTotalPriceForReceipt(
						"kid"
					)}\n\nAdditional\nSnacks & Lunch: ${
						data.snacks ? countTotalPriceForReceipt("snacks") : "No"
					}\nSwimming Kit: ${
						data.swimKit ? countTotalPriceForReceipt("swimKit") : "No"
					}\n\nVoucher\nCode: ${data.voucher}\nDiscount: ${
						data.discount
					}\n\nTotal Price: ${countTotalPriceForReceipt("totalPrice")}`;

					currentQRCodeURL = `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(
						qrText
					)}&size=200x200`;

					document.getElementById("qrcode").src = currentQRCodeURL;

					document.getElementById("confirmModal").showModal();
				});

			document
				.getElementById("downloadQRBtn")
				.addEventListener("click", function () {
					if (currentQRCodeURL) {
						fetch(currentQRCodeURL)
							.then((response) => response.blob())
							.then((blob) => {
								const url = window.URL.createObjectURL(blob);
								const a = document.createElement("a");
								a.style.display = "none";
								a.href = url;
								a.download = "qrcode.png";
								document.body.appendChild(a);
								a.click();
								window.URL.revokeObjectURL(url);
								document.body.removeChild(a);
							})
							.catch(() => alert("Failed to download QR code."));
					} else {
						alert("Please generate a QR code first.");
					}
				});

			document
				.getElementById("scanQRBtn")
				.addEventListener("click", function () {
					document.getElementById("fileInput").click();
				});

			document
				.getElementById("fileInput")
				.addEventListener("change", (event) => {
					const file = event.target.files[0];
					if (file) {
						const formData = new FormData();
						formData.append("file", file);

						fetch("https://api.qrserver.com/v1/read-qr-code/", {
							method: "POST",
							body: formData,
						})
							.then((response) => response.json())
							.then((result) => {
								const decodedTextValue = result[0]?.symbol[0]?.data;
								if (decodedTextValue) {
									document.getElementById("decodedText").textContent =
										decodedTextValue;
								} else {
									document.getElementById("decodedText").textContent =
										"No QR code found or unable to decode.";
								}
							})
							.catch((err) => {
								console.error("Error decoding QR code:", err);
							});
					}
					document.getElementById("scannedModal").showModal();
				});

			function saveReservation(data) {
				const reservations =
					JSON.parse(localStorage.getItem("reservations")) || [];
				reservations.push(data);
				localStorage.setItem("reservations", JSON.stringify(reservations));
			}

			let checkDiscountForReceipt = () => {
				switch (document.getElementById("voucher").value) {
					case "D10000":
						price.discount = 10;
						return "Rp10,000";
						break;
					case "D20000":
						price.discount = 20;
						return "Rp20,000";
						break;
					case "DS50000":
						price.discount = 50;
						return "Rp50,000";
						break;
					case "DX100000":
						price.discount = 100;
						return "Rp100,000";
						break;
					case "DM375000":
						price.discount = 275;
						return "Rp375,000";
						break;
					default:
						price.discount = 0;
						return "Rp0,000";
						break;
				}
			};

			let countTotalPriceForReceipt = (typePrice) => {
				let adult = parseInt(document.getElementById("ticketAdult").value);
				let kid = parseInt(document.getElementById("ticketKid").value);
				let snacks = document.getElementById("snacksLunch");
				let swimKit = document.getElementById("swimKit");
				let totalTicket = adult + kid;
				let result;

				switch (typePrice) {
					case "adult":
						result = adult * 30;
						return `${adult} x Rp30,000 = Rp${result},000`;
						break;
					case "kid":
						result = kid * 25;
						return `${kid} x Rp25,000 = Rp${result},000`;
						break;
					case "snacks":
						result = totalTicket * 20;
						return `${totalTicket} x Rp20,000 = Rp${result},000`;
						break;
					case "swimKit":
						result = totalTicket * 15;
						return `${totalTicket} x Rp15,000 = Rp${result},000`;
						break;
					case "totalPrice":
						result =
							adult * 30 +
							kid * 25 +
							(snacks.checked ? totalTicket * 20 : 0) +
							(swimKit.checked ? totalTicket * 15 : 0) -
							price.discount;
						return `Rp${result},000`;
						break;
					default:
						console.log("countTotalPriceForReceipt", "error pass data");
						break;
				}
			};
		</script>
	</body>
</html>
